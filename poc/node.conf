# Example Valkey configuration with LDAP and exempted users
# This configuration demonstrates how to set up LDAP authentication
# while exempting certain users for local authentication

# Load the LDAP module
loadmodule /var/lib/falkordb/libvalkey_ldap.so
loadmodule /var/lib/falkordb/bin/falkordb.so

# Basic LDAP server configuration
ldap.servers "ldap://ldap ldap://ldap-2"
ldap.auth_mode "search+bind"

ldap.tls_ca_cert_path "/valkey-ldap/valkey-ldap-ca.crt"
ldap.tls_cert_path "/valkey-ldap/valkey-ldap-client.crt"
ldap.tls_key_path "/valkey-ldap/valkey-ldap-client.key"

# Search+Bind mode settings
ldap.search_base "dc=valkey,dc=io"
ldap.search_filter "objectClass=inetOrgPerson"
ldap.search_attribute "uid"
ldap.search_bind_dn "cn=readonly,dc=valkey,dc=io"
ldap.search_bind_passwd "readonly-password"

# Group-based authorization
ldap.groups_search_base "ou=groups,dc=valkey,dc=io"
ldap.groups_filter "objectClass=groupOfNames"
ldap.groups_member_attribute "member"
ldap.groups_rules_attribute "valkeyACL"
ldap.default_acl_rules "on resetpass"

# Exempt certain users from LDAP authentication
# These users will use local Valkey authentication instead
# This is useful for:
# - Super admin users (default)
# - Monitoring/metrics exporters
# - Inter-node replication
# - Service accounts with high-frequency authentication
ldap.exempted_users_regex "^(default|exporter|replication|metrics-.*|admin)$"

# Connection pool settings
ldap.connection_pool_size 4
ldap.timeout_connection 10
ldap.timeout_ldap_operation 10

# Create ACL users
# Exempted users need local passwords
user default on >SuperSecretPassword ~* +@all

# Metrics exporter with read-only access
user exporter on >ExporterPassword ~* +@read -@write -@dangerous

# Replication user
user replication on >ReplicationPassword ~* +@all
