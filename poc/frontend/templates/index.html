<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FalkorDB LDAP User Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input[type="text"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .users-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .user-item, .group-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .user-item:hover, .group-item:hover {
            background: #e9ecef;
        }

        .user-info, .group-info {
            flex: 1;
        }

        .user-info strong, .group-info strong {
            display: block;
            color: #333;
            margin-bottom: 5px;
        }

        .user-info small, .group-info small {
            color: #666;
            display: block;
        }

        .user-actions, .group-actions {
            display: flex;
            gap: 10px;
        }

        .user-actions button, .group-actions button {
            padding: 8px 16px;
            font-size: 12px;
        }

        .test-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }

        .test-result.success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .test-result.error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }

        .test-result pre {
            background: white;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 10px;
            font-size: 12px;
        }

        .alert {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .template-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .template-buttons button {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            font-size: 12px;
        }

        .command-examples {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
        }

        .command-examples strong {
            display: block;
            margin-bottom: 5px;
            color: #667eea;
        }

        .command-examples code {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 2px;
            display: inline-block;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .members-list {
            margin-top: 10px;
            font-size: 12px;
        }

        .members-list .member {
            background: white;
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üóÑÔ∏è FalkorDB LDAP User Management</h1>
            <p>Multi-tenant Database-as-a-Service - User & Permission Manager</p>
        </header>

        <div class="main-content">
            <!-- Create User Section -->
            <div class="card">
                <h2>Create New User</h2>
                <div id="createUserAlert" class="alert"></div>
                <form id="createUserForm">
                    <div class="form-group">
                        <label for="newUserCn">Full Name (CN):</label>
                        <input type="text" id="newUserCn" required placeholder="e.g., Test User">
                    </div>
                    <div class="form-group">
                        <label for="newUserUid">Username (UID):</label>
                        <input type="text" id="newUserUid" required placeholder="e.g., testuser">
                    </div>
                    <div class="form-group">
                        <label for="newUserSn">Surname (SN):</label>
                        <input type="text" id="newUserSn" required placeholder="e.g., User">
                    </div>
                    <div class="form-group">
                        <label for="newUserPassword">Password:</label>
                        <input type="password" id="newUserPassword" required placeholder="Enter password">
                    </div>
                    <button type="submit">Create User</button>
                </form>
            </div>

            <!-- Users List Section -->
            <div class="card">
                <h2>LDAP Users</h2>
                <button onclick="loadUsers()" class="btn-secondary">üîÑ Refresh Users</button>
                <div class="loading" id="usersLoading">
                    <div class="spinner"></div>
                </div>
                <div class="users-list" id="usersList"></div>
            </div>

            <!-- Create Group Section -->
            <div class="card">
                <h2>Create New Group</h2>
                <div id="createGroupAlert" class="alert"></div>
                <form id="createGroupForm">
                    <div class="form-group">
                        <label for="newGroupCn">Group Name:</label>
                        <input type="text" id="newGroupCn" required placeholder="e.g., developers">
                    </div>
                    <div class="form-group">
                        <label for="newGroupAcl">ACL Rules:</label>
                        <textarea id="newGroupAcl" rows="2" placeholder="e.g., +@read ~*">+@read ~*</textarea>
                        <div class="template-buttons">
                            <button type="button" onclick="setNewGroupAcl('full_access')">Full Access</button>
                            <button type="button" onclick="setNewGroupAcl('readonly')">Read Only</button>
                            <button type="button" onclick="setNewGroupAcl('ping_only')">Ping Only</button>
                        </div>
                    </div>
                    <button type="submit">Create Group</button>
                </form>
            </div>

            <!-- Groups Management Section -->
            <div class="card">
                <h2>Manage Groups & Permissions</h2>
                <button onclick="loadGroups()" class="btn-secondary">üîÑ Refresh Groups</button>
                <div class="loading" id="groupsLoading">
                    <div class="spinner"></div>
                </div>
                <div class="users-list" id="groupsList"></div>
            </div>

            <!-- Permission Testing Section -->
            <div class="card">
                <h2>Test User Permissions</h2>
                <div id="testAlert" class="alert"></div>
                <form id="testPermissionsForm">
                    <div class="form-group">
                        <label for="testUsername">Username:</label>
                        <input type="text" id="testUsername" required placeholder="Enter username (UID)">
                    </div>
                    <div class="form-group">
                        <label for="testPassword">Password:</label>
                        <input type="password" id="testPassword" required placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label for="testCommand">Command to Test:</label>
                        <input type="text" id="testCommand" value="PING" placeholder="e.g., PING, INFO, SET key value, GET key">
                        <div class="command-examples">
                            <strong>Example commands:</strong>
                            <code>PING</code>
                            <code>INFO</code>
                            <code>SET mykey myvalue</code>
                            <code>GET mykey</code>
                            <code>DBSIZE</code>
                        </div>
                    </div>
                    <button type="submit">Test Connection & Permissions</button>
                </form>
                <div id="testResult"></div>
            </div>
        </div>

        <!-- Update Group Permissions Modal (inline) -->
        <div id="updatePermissionsModal" class="card full-width" style="display: none;">
            <h2>Update Group Permissions</h2>
            <div id="updatePermAlert" class="alert"></div>
            <form id="updatePermissionsForm">
                <input type="hidden" id="updateGroupCn">
                <div class="form-group">
                    <label for="updateAclRules">ACL Rules:</label>
                    <textarea id="updateAclRules" rows="3" placeholder="e.g., +@all ~* or +@read ~*"></textarea>
                    <div class="template-buttons">
                        <button type="button" onclick="setAclTemplate('full_access')">Full Access</button>
                        <button type="button" onclick="setAclTemplate('readonly')">Read Only</button>
                        <button type="button" onclick="setAclTemplate('ping_only')">Ping Only</button>
                        <button type="button" onclick="setAclTemplate('no_access')">No Access</button>
                        <button type="button" onclick="setAclTemplate('write_only')">Write Only</button>
                        <button type="button" onclick="setAclTemplate('admin_commands')">Admin Commands</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit">Update Permissions</button>
                    <button type="button" class="btn-secondary" onclick="closePermissionsModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const ACL_TEMPLATES = {{ acl_templates | tojson }};

        // Load users on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            loadGroups();
        });

        // Create user form submission
        document.getElementById('createUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const alertDiv = document.getElementById('createUserAlert');
            const data = {
                cn: document.getElementById('newUserCn').value,
                uid: document.getElementById('newUserUid').value,
                sn: document.getElementById('newUserSn').value,
                password: document.getElementById('newUserPassword').value
            };

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(alertDiv, 'success', result.message);
                    document.getElementById('createUserForm').reset();
                    loadUsers();
                } else {
                    showAlert(alertDiv, 'error', result.error);
                }
            } catch (error) {
                showAlert(alertDiv, 'error', 'Failed to create user: ' + error.message);
            }
        });

        // Test permissions form submission
        document.getElementById('testPermissionsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const resultDiv = document.getElementById('testResult');
            const alertDiv = document.getElementById('testAlert');
            const data = {
                username: document.getElementById('testUsername').value,
                password: document.getElementById('testPassword').value,
                command: document.getElementById('testCommand').value
            };

            resultDiv.innerHTML = '<div class="loading show"><div class="spinner"></div></div>';

            try {
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    const res = result.result;
                    let html = `<div class="test-result ${res.authenticated ? 'success' : 'error'}">`;
                    html += `<strong>Connection Test Results for user: ${data.username}</strong>`;
                    html += `<p>‚úì Connected: ${res.connected ? 'Yes' : 'No'}</p>`;
                    html += `<p>‚úì Authenticated: ${res.authenticated ? 'Yes' : 'No'}</p>`;
                    
                    if (res.command_result) {
                        html += `<p><strong>Command Result (${data.command}):</strong></p>`;
                        html += `<pre>${escapeHtml(res.command_result)}</pre>`;
                    }
                    
                    if (res.acl_list) {
                        html += `<p><strong>User ACL Info:</strong></p>`;
                        html += `<pre>${escapeHtml(res.acl_list)}</pre>`;
                    }
                    
                    if (res.error) {
                        html += `<p><strong>Error:</strong> ${escapeHtml(res.error)}</p>`;
                    }
                    
                    html += `</div>`;
                    resultDiv.innerHTML = html;
                } else {
                    const res = result.result || {};
                    let html = `<div class="test-result error">`;
                    html += `<strong>Connection Test Failed for user: ${data.username}</strong>`;
                    html += `<p>Error: ${escapeHtml(result.error || res.error || 'Unknown error')}</p>`;
                    html += `</div>`;
                    resultDiv.innerHTML = html;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error"><strong>Error:</strong> ${escapeHtml(error.message)}</div>`;
            }
        });

        async function loadUsers() {
            const loadingDiv = document.getElementById('usersLoading');
            const listDiv = document.getElementById('usersList');
            
            loadingDiv.classList.add('show');
            
            try {
                const response = await fetch('/api/users');
                const result = await response.json();
                
                if (result.success) {
                    if (result.users.length === 0) {
                        listDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No users found</p>';
                    } else {
                        listDiv.innerHTML = result.users.map(user => `
                            <div class="user-item">
                                <div class="user-info">
                                    <strong>${escapeHtml(user.cn)}</strong>
                                    <small>UID: ${escapeHtml(user.uid)} | SN: ${escapeHtml(user.sn)}</small>
                                    <small style="color: #999; font-size: 10px;">${escapeHtml(user.dn)}</small>
                                </div>
                                <div class="user-actions">
                                    <button class="btn-danger" onclick="deleteUser('${escapeHtml(user.dn)}', '${escapeHtml(user.cn)}')">Delete</button>
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    listDiv.innerHTML = `<p style="color: red;">Error loading users: ${escapeHtml(result.error)}</p>`;
                }
            } catch (error) {
                listDiv.innerHTML = `<p style="color: red;">Failed to load users: ${escapeHtml(error.message)}</p>`;
            } finally {
                loadingDiv.classList.remove('show');
            }
        }

        async function loadGroups() {
            const loadingDiv = document.getElementById('groupsLoading');
            const listDiv = document.getElementById('groupsList');
            
            loadingDiv.classList.add('show');
            
            try {
                const response = await fetch('/api/groups');
                const result = await response.json();
                
                if (result.success) {
                    if (result.groups.length === 0) {
                        listDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No groups found</p>';
                    } else {
                        listDiv.innerHTML = result.groups.map(group => `
                            <div class="group-item">
                                <div class="group-info">
                                    <strong>${escapeHtml(group.cn)}</strong>
                                    <small>ACL: ${escapeHtml(group.description || 'Not set')}</small>
                                    <div class="members-list">
                                        <strong>Members (${group.members.length}):</strong>
                                        ${group.members.map(m => {
                                            const memberUid = m.split(',')[0].replace('cn=', '');
                                            return `<div class="member">
                                                ${escapeHtml(m)}
                                                <button style="margin-left: 10px; padding: 2px 8px; font-size: 11px;" 
                                                        class="btn-danger" 
                                                        onclick="removeMemberFromGroup('${escapeHtml(group.cn)}', '${escapeHtml(m)}')">Remove</button>
                                            </div>`;
                                        }).join('')}
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <button onclick="showAddMemberForm('${escapeHtml(group.cn)}')" style="padding: 6px 12px; font-size: 12px;">+ Add Member</button>
                                    </div>
                                </div>
                                <div class="group-actions">
                                    <button onclick="openPermissionsModal('${escapeHtml(group.cn)}', '${escapeHtml(group.description)}')">Edit Permissions</button>
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    listDiv.innerHTML = `<p style="color: red;">Error loading groups: ${escapeHtml(result.error)}</p>`;
                }
            } catch (error) {
                listDiv.innerHTML = `<p style="color: red;">Failed to load groups: ${escapeHtml(error.message)}</p>`;
            } finally {
                loadingDiv.classList.remove('show');
            }
        }

        async function deleteUser(dn, cn) {
            if (!confirm(`Are you sure you want to delete user "${cn}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/users/${encodeURIComponent(dn)}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    loadUsers();
                    loadGroups(); // Refresh groups as well since user might have been removed from groups
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Failed to delete user: ' + error.message);
            }
        }

        function openPermissionsModal(groupCn, currentAcl) {
            document.getElementById('updateGroupCn').value = groupCn;
            document.getElementById('updateAclRules').value = currentAcl || '';
            document.getElementById('updatePermissionsModal').style.display = 'block';
            document.getElementById('updatePermissionsModal').scrollIntoView({ behavior: 'smooth' });
        }

        function closePermissionsModal() {
            document.getElementById('updatePermissionsModal').style.display = 'none';
            document.getElementById('updatePermissionsForm').reset();
        }

        function setAclTemplate(templateName) {
            const aclRules = ACL_TEMPLATES[templateName];
            document.getElementById('updateAclRules').value = aclRules;
        }

        document.getElementById('updatePermissionsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const alertDiv = document.getElementById('updatePermAlert');
            const groupCn = document.getElementById('updateGroupCn').value;
            const aclRules = document.getElementById('updateAclRules').value;

            try {
                const response = await fetch(`/api/groups/${encodeURIComponent(groupCn)}/permissions`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ acl_rules: aclRules })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(alertDiv, 'success', result.message);
                    loadGroups();
                    setTimeout(() => closePermissionsModal(), 2000);
                } else {
                    showAlert(alertDiv, 'error', result.error);
                }
            } catch (error) {
                showAlert(alertDiv, 'error', 'Failed to update permissions: ' + error.message);
            }
        });

        function showAlert(element, type, message) {
            element.className = `alert alert-${type} show`;
            element.textContent = message;
            setTimeout(() => {
                element.classList.remove('show');
            }, 5000);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // Create group form submission
        document.getElementById('createGroupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const alertDiv = document.getElementById('createGroupAlert');
            const data = {
                cn: document.getElementById('newGroupCn').value,
                description: document.getElementById('newGroupAcl').value
            };

            try {
                const response = await fetch('/api/groups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert(alertDiv, 'success', result.message);
                    document.getElementById('createGroupForm').reset();
                    loadGroups();
                } else {
                    showAlert(alertDiv, 'error', result.error);
                }
            } catch (error) {
                showAlert(alertDiv, 'error', 'Failed to create group: ' + error.message);
            }
        });

        function setNewGroupAcl(templateName) {
            const aclRules = ACL_TEMPLATES[templateName];
            document.getElementById('newGroupAcl').value = aclRules;
        }

        async function showAddMemberForm(groupCn) {
            // Fetch all users first
            try {
                const response = await fetch('/api/users');
                const result = await response.json();
                
                if (!result.success) {
                    alert('Failed to load users: ' + result.error);
                    return;
                }

                const users = result.users;
                const userDn = prompt(
                    `Add user to group "${groupCn}"\n\nAvailable users:\n` +
                    users.map((u, i) => `${i+1}. ${u.cn} (${u.uid})`).join('\n') +
                    '\n\nEnter user DN (or select by number):'
                );

                if (!userDn) return;

                // Check if user entered a number
                const userIndex = parseInt(userDn);
                let selectedUserDn;
                
                if (!isNaN(userIndex) && userIndex > 0 && userIndex <= users.length) {
                    selectedUserDn = users[userIndex - 1].dn;
                } else {
                    selectedUserDn = userDn;
                }

                await addMemberToGroup(groupCn, selectedUserDn);
            } catch (error) {
                alert('Failed to add member: ' + error.message);
            }
        }

        async function addMemberToGroup(groupCn, userDn) {
            try {
                const response = await fetch(`/api/groups/${encodeURIComponent(groupCn)}/members`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_dn: userDn })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    loadGroups();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Failed to add member: ' + error.message);
            }
        }

        async function removeMemberFromGroup(groupCn, userDn) {
            if (!confirm(`Remove user from group "${groupCn}"?\n\n${userDn}`)) {
                return;
            }

            try {
                const response = await fetch(`/api/groups/${encodeURIComponent(groupCn)}/members`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_dn: userDn })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    loadGroups();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Failed to remove member: ' + error.message);
            }
        }
    </script>
</body>
</html>
