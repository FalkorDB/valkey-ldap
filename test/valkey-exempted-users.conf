# Example Valkey configuration with LDAP and exempted users
# This configuration demonstrates how to set up LDAP authentication
# while exempting certain users for local authentication

# Load the LDAP module
loadmodule /path/to/valkey-ldap.so

# Basic LDAP server configuration
ldap.servers "ldap://ldap.example.com:389"
ldap.auth_mode "search+bind"

# TLS configuration (optional but recommended)
ldap.use_starttls yes
ldap.tls_ca_cert_path "/etc/valkey/ldap/ca-cert.pem"

# Search+Bind mode settings
ldap.search_base "ou=users,dc=example,dc=com"
ldap.search_filter "objectClass=inetOrgPerson"
ldap.search_attribute "uid"
ldap.search_bind_dn "cn=readonly,dc=example,dc=com"
ldap.search_bind_passwd "readonly-password"

# Group-based authorization
ldap.groups_search_base "ou=groups,dc=example,dc=com"
ldap.groups_filter "objectClass=groupOfNames"
ldap.groups_member_attribute "member"
ldap.groups_rules_attribute "valkeyACL"
ldap.default_acl_rules "on resetpass"

# Exempt certain users from LDAP authentication
# These users will use local Valkey authentication instead
# This is useful for:
# - Super admin users (default)
# - Monitoring/metrics exporters
# - Inter-node replication
# - Service accounts with high-frequency authentication
ldap.exempted_users_regex "^(default|exporter|replication|metrics-.*|admin)$"

# Connection pool settings
ldap.connection_pool_size 4
ldap.timeout_connection 10
ldap.timeout_ldap_operation 10

# Create ACL users
# Exempted users need local passwords
user default on >SuperSecretPassword ~* +@all

# Metrics exporter with read-only access
user exporter on >ExporterPassword ~* +@read -@write -@dangerous

# Replication user
user replication on >ReplicationPassword ~* +@all

# Regular LDAP users (no local password)
# These will authenticate via LDAP
user alice on resetpass ~* +@all
user bob on resetpass ~* +@read
user charlie on resetpass ~* +@write +@read
